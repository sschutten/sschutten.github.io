<!doctype html><html><head><title>Connect to Azure AD secured SignalR Hub from your SPFx code</title>
<meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/layouts/main.css><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/navigators/navbar.css><link rel=stylesheet href=/css/plyr.css><link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css><link rel=icon type=image/png href=/images/favicon_hu71cff7c6f06c0ce56c441b69c0864ea6_5216_42x0_resize_box_3.png><link rel=stylesheet href=/css/style.css><meta name=description content="Connect to Azure AD secured SignalR Hub from your SPFx code"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/css/layouts/single.css><link rel=stylesheet href=/css/navigators/sidebar.css><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-xxxxxxxx","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span>
</button>
<a class=navbar-brand href=/><img src=/images/main-logo_hu71cff7c6f06c0ce56c441b69c0864ea6_5216_42x0_resize_box_3.png alt=Logo>Sander Schutten's Blog</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div><img src=/images/main-logo_hu71cff7c6f06c0ce56c441b69c0864ea6_5216_42x0_resize_box_3.png class=d-none id=main-logo alt=Logo>
<img src=/images/inverted-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_42x0_resize_box_3.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=https://sschutten.github.io/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts data-filter=all>Posts</a></li><div class=subtree><li><i class="fas fa-plus-circle"></i><a href=/posts/2021/>2021</a><ul><li><a href=/posts/2021/04/>April</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2019/>2019</a><ul><li><i class="fas fa-plus-circle"></i><a href=/posts/2019/10/>October</a><ul><li><a href=/posts/2019/10/difference-between-apply-to-each-and-for-each-actions/>Difference between Apply to each and For each actions</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2019/09/>September</a><ul><li><a href=/posts/2019/09/intelligent-digital-assitants/>Intelligent chatbots for Microsoft Teams</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2019/08/>August</a><ul><li><a href=/posts/2019/08/edge-multi-profile-with-custom-images/>Custom profile images in Edge</a></li></ul></li></ul></li><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/2018/>2018</a><ul class=active><li><i class="fas fa-plus-circle"></i><a href=/posts/2018/02/>February</a><ul><li><a href=/posts/2018/02/logic-apps-improvement-suggestions/>Logic Apps improvement suggestions</a></li></ul></li><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/2018/12/>December</a><ul class=active><li><a class=active href=/posts/2018/12/connect-azure-ad-authenticated-signalr-hub-from-spfx/>Connect to Azure AD secured SignalR Hub from your SPFx code</a></li></ul></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2017/>2017</a><ul><li><a href=/posts/2017/11/>November</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2013/>2013</a><ul><li><i class="fas fa-plus-circle"></i><a href=/posts/2013/06/>June</a><ul><li><a href=/posts/2013/06/move-your-development-vm-to-azure/>Move your development VM to Azure</a></li></ul></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2012/>2012</a><ul><li><i class="fas fa-plus-circle"></i><a href=/posts/2012/09/>September</a><ul><li><a href=/posts/2012/09/preparing-for-70-484-essentials-of-developing-windows-metro-style-apps-using-c/>Preparing for 70-484: Essentials of Developing Windows Metro style Apps using C#</a></li><li><a href=/posts/2012/09/preparing-for-70-485-advanced-metro-style-app-development-using-c/>Preparing for 70-485: Advanced Metro style App Development using C#</a></li></ul></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2011/>2011</a><ul><li><i class="fas fa-plus-circle"></i><a href=/posts/2011/08/>August</a><ul><li><a href=/posts/2011/08/lightswitch-custom-ribbon-button/>Lightswitch: custom ribbon button</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2011/07/>July</a><ul><li><a href=/posts/2011/07/windows-phone-7-mango-features/>Windows Phone 7 Mango features</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2011/04/>April</a><ul><li><a href=/posts/2011/04/mix11-boot-camps/>MIX11: Boot Camps</a></li><li><a href=/posts/2011/04/mix11-day-1/>MIX11: Day 1</a></li><li><a href=/posts/2011/04/mix11-day-2/>MIX11: Day 2</a></li><li><a href=/posts/2011/04/mix11-day-3/>MIX11: Day 3</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2011/03/>March</a><ul><li><a href=/posts/2011/03/advanced-mvvm-doing-visual-states-properly/>Advanced MVVM: Doing visual states properly</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2011/01/>January</a><ul><li><a href=/posts/2011/01/using-the-sync-framework-on-windows-phone-7/>Using the Sync Framework on Windows Phone 7</a></li></ul></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2010/>2010</a><ul><li><i class="fas fa-plus-circle"></i><a href=/posts/2010/11/>November</a><ul><li><a href=/posts/2010/11/wcf-ria-services-odata-endpoint-does-not-support-update-or-linq/>WCF RIA Services OData endpoint does NOT support update or LINQ</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2010/12/>December</a><ul><li><a href=/posts/2010/12/building-a-location-aware-windows-phone-7-application-2/>Building a location aware Windows Phone 7 application</a></li></ul></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2009/>2009</a><ul><li><i class="fas fa-plus-circle"></i><a href=/posts/2009/01/>January</a><ul><li><a href=/posts/2009/01/mce-guide-editor-source-code/>MCE Guide Editor source code</a></li></ul></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2008/>2008</a><ul><li><i class="fas fa-plus-circle"></i><a href=/posts/2008/11/>November</a><ul><li><a href=/posts/2008/11/building-vista-media-center-add-ins-dutch/>Building Vista Media Center Add-ins (Dutch)</a></li><li><a href=/posts/2008/11/honk-twice-if-you-see-us/>Honk twice if you see us!</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2008/10/>October</a><ul><li><a href=/posts/2008/10/better-wssf-solution-structure/>Better WSSF solution structure</a></li><li><a href=/posts/2008/10/consume-wcf-service-using-sharepoint-designer/>Consume WCF service using Sharepoint Designer</a></li><li><a href=/posts/2008/10/day-0-arrived-in-la/>Day 0: arrived in LA</a></li></ul></li><li><a href=/posts/2008/09/>September</a></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2008/08/>August</a><ul><li><a href=/posts/2008/08/first-release-of-viddlernet/>First release of Viddler.Net</a></li><li><a href=/posts/2008/08/viddlernet-on-codeplex/>Viddler.Net on Codeplex</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2008/07/>July</a><ul><li><a href=/posts/2008/07/biztalk-server-capabilities-poster/>BizTalk Server capabilities poster</a></li><li><a href=/posts/2008/07/bizunit-designer/>BizUnit Designer</a></li><li><a href=/posts/2008/07/control-windows-media-center-with-new-windows-sideshow-beta-gadgets/>Control Windows Media Center with New Windows SideShow BETA Gadgets</a></li><li><a href=/posts/2008/07/ext-js/>Ext JS</a></li><li><a href=/posts/2008/07/farpoint-spread-for-biztalk-server-2006/>FarPoint Spread for BizTalk Server 2006</a></li><li><a href=/posts/2008/07/first-look-at-wcf-adapter-for-biztalk-server-2006-r2/>First look at WCF Adapter for BizTalk Server 2006 R2</a></li><li><a href=/posts/2008/07/86/>Home Server campaign</a></li><li><a href=/posts/2008/07/84/>How-To: New ASP.NET 3.5 Extensions Video Screencasts</a></li><li><a href=/posts/2008/07/map-xsstring-to-xsdatetime/>Map xs:string to xs:datetime</a></li><li><a href=/posts/2008/07/microsoft-biztalk-server-performance-optimization-guide/>Microsoft BizTalk Server Performance Optimization Guide</a></li><li><a href=/posts/2008/07/microsoft-loadgen-2007/>Microsoft LoadGen 2007</a></li><li><a href=/posts/2008/07/more-biztalk-posters/>More BizTalk posters</a></li><li><a href=/posts/2008/07/released-biztalk-server-2006-extentions-for-wf/>Released: BizTalk Server 2006 extentions for WF</a></li><li><a href=/posts/2008/07/video-biztalk-services-explained/>Video: BizTalk Services Explained</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2008/04/>April</a><ul><li><a href=/posts/2008/04/biztalk-server-2006-r3-just-around-the-corner/>BizTalk Server 2006 R3 just around the corner</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2008/03/>March</a><ul><li><a href=/posts/2008/03/status-update-on-mce-guide-editor/>Status update on MCE Guide Editor</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2008/02/>February</a><ul><li><a href=/posts/2008/02/jonas-butt-the-new-it-talent/>Jonas Butt, the new IT-talent?</a></li><li><a href=/posts/2008/02/63/>Running</a></li></ul></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2007/>2007</a><ul><li><i class="fas fa-plus-circle"></i><a href=/posts/2007/06/>June</a><ul><li><a href=/posts/2007/06/devdays-2007-were-you-there/>DevDays 2007, were you there?</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2007/05/>May</a><ul><li><a href=/posts/2007/05/first-release-of-mce-guide-editor/>First release of MCE Guide Editor</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2007/02/>February</a><ul><li><a href=/posts/2007/02/net-magazine-article-published-online/>.Net Magazine article published online</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2007/01/>January</a><ul><li><a href=/posts/2007/01/accessing-flat-file-content-in-orchestration/>Accessing flat file content in orchestration</a></li><li><a href=/posts/2007/01/biztalk-adapter-whitepaper/>BizTalk Adapter whitepaper</a></li><li><a href=/posts/2007/01/biztalk-shell-extension/>BizTalk shell extension</a></li><li><a href=/posts/2007/01/biztalk-troubleshooting-guide/>BizTalk Troubleshooting Guide</a></li><li><a href=/posts/2007/01/mcts-biztalk-server-2006/>MCTS BizTalk Server 2006</a></li><li><a href=/posts/2007/01/pipeline-testing-framework-for-bts06/>Pipeline Testing Framework for BTS06</a></li><li><a href=/posts/2007/01/playing-blog-tag/>Playing Blog-Tag</a></li><li><a href=/posts/2007/01/storing-configuration-inside-sso-database/>Storing configuration inside SSO database</a></li><li><a href=/posts/2007/01/using-bam-api-to-create-related-activities/>Using BAM API to create related activities</a></li></ul></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2006/>2006</a><ul><li><i class="fas fa-plus-circle"></i><a href=/posts/2006/11/>November</a><ul><li><a href=/posts/2006/11/add-existing-project-from-web-drama/>Add existing project from web drama</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2006/03/>March</a><ul><li><a href=/posts/2006/03/developing-for-vista-media-center/>Developing for Vista Media Center</a></li><li><a href=/posts/2006/03/html-generator-stylesheet-for-biztalk-2004-maps/>HTML Generator Stylesheet for BizTalk 2004 Maps</a></li><li><a href=/posts/2006/03/increase-xslt-performance-by-using-xlskey/>Increase XSLT performance by using xls:key</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2006/02/>February</a><ul><li><a href=/posts/2006/02/biztalk-load-generation-utility-reloaded/>BizTalk Load Generation Utility reloaded</a></li><li><a href=/posts/2006/02/biztalk-performance-tester-released/>BizTalk Performance Tester released</a></li><li><a href=/posts/2006/02/devdays-7-8-march/>DevDays 7 &amp;amp; 8 March</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2006/01/>January</a><ul><li><a href=/posts/2006/01/happy-new-year/>Happy new year!</a></li><li><a href=/posts/2006/01/identify-node-type-in-xslt/>Identify node type in XSLT</a></li><li><a href=/posts/2006/01/suppress-xml-documentation-warnings-for-a-project/>Suppress XML documentation warnings for a project</a></li></ul></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2005/>2005</a><ul><li><i class="fas fa-plus-circle"></i><a href=/posts/2005/11/>November</a><ul><li><a href=/posts/2005/11/access-message-properties-inside-custom-pipeline-component/>Access message properties inside custom pipeline component</a></li><li><a href=/posts/2005/11/biztalk-server-2006-ctm-released/>BizTalk Server 2006 CTM Released</a></li><li><a href=/posts/2005/11/biztalks-sexy-new-xslt-mapper/>BizTalk&amp;#039;s sexy new XSLT mapper</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2005/10/>October</a><ul><li><a href=/posts/2005/10/biztalk-2006-beta-1/>BizTalk 2006 Beta 1</a></li><li><a href=/posts/2005/10/bizunit-20-released/>BizUnit 2.0 released</a></li><li><a href=/posts/2005/10/joining-the-overloaded-web-log-community/>Joining the overloaded web-log community</a></li><li><a href=/posts/2005/10/workflow-designer-will-substitute-orchestration-designer-in-biztalk-vnext/>Workflow designer will substitute orchestration designer in BizTalk vNext</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/2005/12/>December</a><ul><li><a href=/posts/2005/12/load-xmlschemas-from-biztalk-assembly/>Load XmlSchema&amp;#039;s from BizTalk assembly</a></li></ul></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://sschutten.github.io/posts/2018/12/connect-azure-ad-authenticated-signalr-hub-from-spfx/hero.png)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/avatar.jpg alt="Author Image"><h5 class=author-name>Sander Schutten</h5><p>December 11, 2018</p></div><div class=title><h1>Connect to Azure AD secured SignalR Hub from your SPFx code</h1></div><div class=post-content id=post-content><p>SignalR is a great technology to provide users with real-time UI updates of events happening in the back-end. It&rsquo;s a perfect match with SPFX to build some amazing web parts for SharePoint. With the recent release of ASPNET SignalR Core (now incorporated in the <a href=https://github.com/aspnet/AspNetCore>ASP.NET Core GitHub project</a>) SignalR is easier to use than before. So you&rsquo;ve gone and created a web part that connects to a SignalR hub and the experience makes a real impact for your users. But how do you ensure only allowed people can connect to the SignalR hub? That&rsquo;s what this blog post will get into.</p><p>This blog post covers the following scenario: you have an SPFX that connects to a SignalR hub and you want to authorize people to the hub using Azure Active Directory. I&rsquo;ve had a lot of help from Sergei Sergeev&rsquo;s post [Call Azure AD secured API from your SPFx code. Story #2: Web app (or Azure Function) and SPFx with adal.js](<a href=http://spblog.net/post/2018/07/29/Call-Azure-AD-secured-API-from-your-SPFx-code-Story-2-Web-app-(or-Azure-Function)>http://spblog.net/post/2018/07/29/Call-Azure-AD-secured-API-from-your-SPFx-code-Story-2-Web-app-(or-Azure-Function)</a>. Go visit his blog, it&rsquo;s full of relevant details.</p><p>We&rsquo;ll be using SPFX framework version 1.6 and ASP.NET SignalR Core. Setting up authentication to flow from SharePoint to the SignalR hub breaks down into the following steps:</p><ol><li>Add new app registration in Azure AD</li><li>Enable authentication in the SignalR hub</li><li>Modify web part to connect to SignalR hub using obtained token</li><li>Allow SharePoint user impersonation</li></ol><h2 id=1-add-new-app-registration-in-azure-ad>1. Add new app registration in Azure AD</h2><p>This step is similar to the step outlined in Sergei&rsquo;s blog, but I&rsquo;ll repeat it here for sake of completeness. In Azure Portal, click Azure Active Directory -> App Registrations. Create a new application registration of type Web app/API and give it a name. Since the sign-on URL won&rsquo;t be used you can pick anything. Let&rsquo;s use <a href=https://localhost:44351/signin-oidc>https://localhost:44351/signin-oidc</a> for now:</p><figure><img src=images/new-app-registration.png></figure><p>Copy the Application ID from the properties. We need it in the next step. You should also copy your Tenant ID. You can find your Tenant Id in the properties section of the Azure Active Directory pane in the Azure Portal. It&rsquo;s called Directory ID.</p><h2 id=2-enable-authentication-in-the-signalr-hub>2. Enable authentication in the SignalR hub</h2><p>To enable Azure AD authentication we first need to add the NuGet package <code>Microsoft.AspNetCore.Authentication.AzureAD.UI</code> to the ASP.NET Core project that hosts the SignalR hub. At this time of writing the lastest stable version is 2.1.1.</p><p>Once the NuGet package is added, we enable authentication by making a few modifications to the code.</p><p>We need to set up the configuration of the service principal that we created in the previous step. During development we use the Secrets Manager tool to prevent our secrets ending up in version control. The Secret Manager tool stores sensitive data during the development of an ASP.NET Core project. App secrets are stored in a separate location from the project tree. The <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/index?view=aspnetcore-2.1">ASP.NET Core Configuration API</a> provides access to Secret Manager secrets. Therefor we don&rsquo;t need to do anything special to access the secrets stored using the Secret Manager.</p><p>Right click the ASP.NET project and choose &lsquo;Manage User Secrets&rsquo;. Visual Studio will create a secrets.json file for you and associates it with your project.</p><figure><img src=images/secret-manager-tool.png></figure><p>Add the following configuration section to the secrets.json using the values you copied in the previous step.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;AzureAd&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Instance&#34;</span>: <span style=color:#e6db74>&#34;https://login.microsoftonline.com/&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;TenantId&#34;</span>: <span style=color:#e6db74>&#34;&lt;your Tenant ID&gt;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;ClientId&#34;</span>: <span style=color:#e6db74>&#34;&lt;the App ID&gt;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;CallbackPath&#34;</span>: <span style=color:#e6db74>&#34;/signin-oidc&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Add a constructor to the <code>Startup</code> class that takes in the <code>IConfiguration</code> dependency and stores it in a local field. This allows us to easily access the configuration in later lifecycle methods. See the following snippet for details. The snippet also shows you how to get other properties through dependency injection like <code>IHostingEnvironment</code> and <code>ILoggerFactory</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Startup</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> IConfiguration _config;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Startup(IHostingEnvironment env,
</span></span><span style=display:flex><span>        IConfiguration config,
</span></span><span style=display:flex><span>        ILoggerFactory loggerFactory)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        _config = config;
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Next add a call to the <code>AddAuthentication</code> extension method on the <code>IServiceCollection</code> in the <code>ConfigureServices</code> lifecycle method of the <code>Startup</code> class. We configure it to use the default Bearer authentication scheme. We furthermore enable Cookie authentication and provide the config for the Azure AD Bearer authentication. The <code>Bind(...)</code> method takes the config from the AzureAd section and attempts to map it to the <code>AzureAdOptions</code> class.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> ConfigureServices(IServiceCollection services)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    services.AddAuthentication(AzureADDefaults.BearerAuthenticationScheme)
</span></span><span style=display:flex><span>        .AddCookie()
</span></span><span style=display:flex><span>        .AddAzureADBearer(options =&gt; _config.Bind(<span style=color:#e6db74>&#34;AzureAd&#34;</span>, options));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Add a call to the <code>UseAuthentication</code> extension method on the <code>IApplicationBuilder</code> in the <code>Configure</code> lifecycle method of the <code>Startup</code> class. This tells ASP.NET Core to actually use the authentication that we&rsquo;ve configured in the <code>ConfigureServices</code> method. Make sure to call the <code>UseAuthentication</code> method before the call to <code>UseSignalR</code> as it can give unexpected results if you add it after.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> Configure(IApplicationBuilder app, IHostingEnvironment env)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    app.UseAuthentication();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    app.UseAzureSignalR(routes =&gt;
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        routes.MapHub&lt;MyHub&gt;(<span style=color:#e6db74>&#34;/myHub&#34;</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Finally we tell the hub that we require authenticated users by adding the <code>Authorize</code> attribute to the hub class, as demonstrated in the following snippet.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a6e22e>[Authorize]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyHub</span> : Hub
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Allright, we&rsquo;ve now set up our hub! Test it out and discover that your web part can no longer connect to the SignalR hub because it must be authenticated. So far so good. Now lets fix the web part.</p><h2 id=3-modify-web-part-to-connect-to-signalr-hub-using-obtained-token>3. Modify web part to connect to SignalR hub using obtained token</h2><p>In order to be able to obtain a token to authorize to the SignalR hub with, we must declare the <code>user_impersonate</code> permission in the <code>package-solution.json</code> file. This permission allows the SharePoint Online Client Extensibility service principal to call web api&rsquo;s as the logged in user. Open the file and add the <code>webApiPermissionRequests</code> element. Use the App ID (or full name of the app registration) as value for the resource.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;$schema&#34;</span>: <span style=color:#e6db74>&#34;https://developer.microsoft.com/json-schemas/spfx-build/package-solution.schema.json&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;solution&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;webApiPermissionRequests&#34;</span>: [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;resource&#34;</span>: <span style=color:#e6db74>&#34;&lt;App ID&gt;&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;scope&#34;</span>: <span style=color:#e6db74>&#34;user_impersonation&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>To authenticate with the SignalR hub we need to send a bearer token when connecting. This means we need to obtain a token and telling SignalR to use that token. Usually we would use the new <code>AadHttpClient</code> to call an API, as this would hide all the ADAL plumbing we need to do to get a token and call the API with the token. Unfortunately we can&rsquo;t use the AadHttpClient with SignalR because it doesn&rsquo;t implement the full HttpClient stack. Fortunately the <code>AadHttpClient</code> uses the <code>AadTokenProvider</code> that&rsquo;s available to us. We will use the token provider to obtain the token and it will do all the magic for us.</p><p>To get the <code>AadTokenProvider</code> we must ask the <code>AadTokenProviderFactory</code> to give us one. The <code>AadTokenProviderFactory</code> is available through the <code>WebPartContext</code> of the <code>BaseClientSideWebPart</code> class. In my case I send the <code>AadTokenProviderFactory</code> as a prop to my React component that does the actual visualization, like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MySampleWebPart</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>BaseClientSideWebPart</span>&lt;<span style=color:#f92672>IMySampleWebPartProps</span>&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>render</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>element</span>: <span style=color:#66d9ef>React.ReactElement</span>&lt;<span style=color:#f92672>IMySampleProps</span>&gt; <span style=color:#f92672>=</span> <span style=color:#a6e22e>React</span>.<span style=color:#a6e22e>createElement</span>(
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>MySample</span>,
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>aadTokenProviderFactory</span>: <span style=color:#66d9ef>this.context.aadTokenProviderFactory</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ReactDom</span>.<span style=color:#a6e22e>render</span>(<span style=color:#a6e22e>element</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>domElement</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>In the React component, add a method to get the token. Later we&rsquo;ll tell the SignalR connection to use this method to get the authorization token. First we get the token provider and then we use the token provider to give us a token for our SignalR hub. The resourceEndpoint parameter should be the URL to your hub.</p><blockquote><p>Note that in my sample I use <code>async/await</code> to handle Promises as this is much easier to read. I would suggest you start using <code>async/await</code> too, but if you like you can use plain Promises instead.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getAccessToken() {</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>tokenProvider</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>props</span>.<span style=color:#a6e22e>aadTokenProviderFactory</span>.<span style=color:#a6e22e>getTokenProvider</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>tokenProvider</span>.<span style=color:#a6e22e>getToken</span>(<span style=color:#e6db74>&#34;&lt;Hub Endpoint&gt;&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>As I mentioned a little earlier we now need to tell the SignalR connection to use this method to obtain the tokens. The <code>withUrl</code> method of the <code>HubConnectionBuilder</code> allows us to specify the <code>IHttpConnectionOptions</code>. One of the options is the <code>accessTokenFactory</code>. We set the <code>assetTokenFactory</code> to be our <code>getAccessToken</code> method, like in the following snippet.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>connection</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>signalR</span>.<span style=color:#a6e22e>HubConnectionBuilder</span>()
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>withUrl</span>(<span style=color:#a6e22e>url</span>, { <span style=color:#a6e22e>accessTokenFactory</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getAccessToken</span> })
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>build</span>();
</span></span></code></pre></div><h2 id=4-allow-sharepoint-user-impersonation>4. Allow SharePoint user impersonation</h2><p>OK, awesome, we&rsquo;re done with modifying our web part code. We&rsquo;re almost there, but before we can actually test our web part we need to approve the <code>user_impersonation</code> permission we declared in our web part. We need to do this in the SharePoint tenant where we want to use or test this web part. You can do this using Powershell, but I&rsquo;ll save that for another post. For now we&rsquo;re going to use the SharePoint admin center.</p><p>Package up your web part and upload the sppkg to the SharePoint app catalog as you&rsquo;d normally do. By uploading the sppkg to the app catalog, SharePoint will discover the declared permissions in your <code>package.solution.json</code>. Once you&rsquo;ve uploaded your package to the app catalog move to your SharePoint admin center (usually https://<tenant>-admin.sharepoint.com). Click &rsquo;try it now&rsquo; to switch to the new SharePoint admin center if it&rsquo;s not yet your default and choose &lsquo;API management&rsquo; from the menu on the left.</p><figure><img src=images/api-management.png></figure><p>This will list you all the permissions pending approval. You should be able to find the <code>user_impersonation</code> permission as requested by your web part. Approve the permission.</p><figure><img src=images/api-management-permissions.png></figure><p>That&rsquo;s it! You&rsquo;re now able to test your web part and this time it should be able to connect to your SignalR hub using authentication.</p><blockquote><p>Note that once you enable authentication you must always test your web part in the hosted workbench. The reason for this is perhaps obvious: in order to obtain a token and authenticate to the SignalR hub you must be logged in with a valid Office 365 account.</p></blockquote></div><div class=btn-improve-page><a href=https://github.com/sschutten/blog/edit/master/content/posts/2018/12/connect-azure-ad-authenticated-signalr-hub-from-spfx/index.md target=_blank><i class="fas fa-code-branch"></i>
Improve this page</a></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/posts/2019/08/edge-multi-profile-with-custom-images/ class="btn btn-outline-info"><div><i class="fas fa-chevron-circle-left"></i> Prev</div><div class=next-prev-text>Custom profile images in Edge</div></a></div><div class="col-md-6 next-article"><a href=/posts/2018/02/logic-apps-improvement-suggestions/ class="btn btn-outline-info"><div>Next <i class="fas fa-chevron-circle-right"></i></div><div class=next-prev-text>Logic Apps improvement suggestions</div></a></div></div><hr><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="does-not-exist",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#1-add-new-app-registration-in-azure-ad>1. Add new app registration in Azure AD</a></li><li><a href=#2-enable-authentication-in-the-signalr-hub>2. Enable authentication in the SignalR hub</a></li><li><a href=#3-modify-web-part-to-connect-to-signalr-hub-using-obtained-token>3. Modify web part to connect to SignalR hub using obtained token</a></li><li><a href=#4-allow-sharepoint-user-impersonation>4. Allow SharePoint user impersonation</a></li></ul></nav></div></div></section></div><footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=/#recent-posts>Recent Posts</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><span>Email: </span><span>sander@dotnetstudio.nl</span></li><li><span>Phone: </span><span>+31 6 3830 4494</span></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hossainemruz/toha target=_blank><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_3.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">Copyright © 2021</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script type=text/javascript src=/js/jquery-3.4.1.min.js></script><script type=text/javascript src=/js/popper.min.js></script><script type=text/javascript src=/js/bootstrap.min.js></script><script type=text/javascript src=/js/navbar.js></script><script type=text/javascript src=/js/plyr.js></script><script type=text/javascript src=/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script><script src=/js/single.js></script><script>hljs.initHighlightingOnLoad()</script></body></html>